<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="d.p001_4">
	<!-- 리절트 맵 정의 -->
	<resultMap id="articleResult" type="d_p001_4VO">
		<result property="rownum" column="rownum" />
		<result property="member_id" column="member_id" />
		<result property="title" column="title" />
		<result property="plan_no" column="plan_no" />
		<result property="register_date" column="register_date" />
		<result property="person_se" column="person_se" />
		<result property="range_date" column="range_date" />
		<result property="open_val" column="open_val" />		
	</resultMap>
	
	<resultMap id="detailResult" type="d_p001_4VO_2">
		<result property="title" column="title" />
		<result property="content_id" column="content_id" />
		<result property="plan_no" column="plan_no" />
		<result property="day_no" column="day_no" />
		<result property="plan_desc" column="plan_desc" />
		<result property="detail_no" column="detail_no" />
		<result property="range_date" column="range_date" />
	</resultMap>
	
	<resultMap id="tagResult" type="d_p001_4VO_3">
		<result property="tag_name" column="tag_name" />
		<result property="plan_no" column="plan_no" />
	</resultMap>

	<!-- 게시글 조회 -->
	<select id="searchArticle" resultMap="articleResult">
		<![CDATA[
			SELECT ROWNUM, title, register_date, member_id, plan_no
			FROM (SELECT ROWNUM, title, register_date, member_id, plan_no
      			  FROM planner
      			  WHERE open_val = 'Y'
      			  ORDER BY register_date)
			ORDER BY ROWNUM desc	
		]]>	
	</select>
	
	<!-- 게시글 상세 조회 -->
	<select id="contentsArticle" resultMap="articleResult" parameterType="String">
		<![CDATA[
			SELECT title, member_id, register_date, person_se, range_date
			FROM planner
			WHERE plan_no = #{plan_no}
		]]>	
	</select>
	
	<!-- 플래너 연동 조회-->
	<select id="plannerDetail" resultMap="detailResult" parameterType="String">
		<![CDATA[		
			SELECT DISTINCT(title), content_id, p.plan_no, plan_desc, day_no, detail_no, range_date
			FROM planner p, planner_detail pd
			WHERE p.plan_no = pd.plan_no
			AND p.plan_no = #{plan_no}
			ORDER BY detail_no
		]]>
	</select>
	
	<!-- 본인 플래너 글 조회 -->
	<select id="selectMyplan" resultMap="articleResult" parameterType="String">
		<![CDATA[
			SELECT plan_no, title, member_id, register_date
			FROM planner
			WHERE member_id = #{member_id}	
		]]>
	
	</select>
	
	<!-- 플래너 내용 추가 -->
	<update id="insertDesc" parameterType="list">
		<foreach collection="list" item="item" separator=";" open="DECLARE BEGIN" close="; END;">
		UPDATE planner_detail
		SET plan_desc = #{item.plan_desc}
		WHERE plan_no = #{item.plan_no}
		AND content_id = #{item.content_id}
		</foreach>
	</update>
	
	<!-- 플래너 추가시 open_val 변경 -->
	<update id="updateOpen" parameterType="list">
		<foreach collection="list" item="item" separator=";" open="DECLARE BEGIN" close="; END;">
				UPDATE planner
				SET open_val = 'Y', title = #{item.title}, register_date = TO_CHAR(sysdate, 'YYYY-MM-DD hh24:mi')
				WHERE plan_no = #{item.plan_no}		
		</foreach>
	</update>
	
	<!-- 태그 조회 -->
	<select id="searchTag" resultMap="tagResult" parameterType="String">
		<![CDATA[
			SELECT tag_name
			FROM tag_planner
			WHERE plan_no = #{plan_no}
		]]>
	</select>
	
	<!-- 플랜 게시글 삭제 -->
	<delete id="deletePlan" parameterType="String">
		<![CDATA[
			UPDATE planner
			SET open_val = 'N'
			WHERE plan_no = #{plan_no}	
		]]>
	</delete>
</mapper>